<!DOCTYPE html>
<html>
  <head>
    <!--
    If you are serving your web app in a path other than the root, change the
    href value below to reflect the base path you are serving from.

    The path provided below has to start and end with a slash "/" in order for
    it to work correctly.

    For more details:
    * https://developer.mozilla.org/en-US/docs/Web/HTML/Element/base
  -->
    <base href="/" />

    <meta charset="UTF-8" />
    <meta content="IE=Edge" http-equiv="X-UA-Compatible" />
    <meta name="description" content="A new Flutter project." />

    <!-- iOS meta tags & icons -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="apple-mobile-web-app-title" content="xpressobooks" />
    <link rel="apple-touch-icon" href="icons/Icon-192.png" />

    <title>xpressobooks-dev</title>
    <link rel="manifest" href="manifest.json" />
    <script src="focus_helper.js"></script>
    <script async src="https://js.stripe.com/v3/"></script>
  </head>
  <body>
    <input
      type="text"
      id="input-field"
      style="opacity: 0"
      autocomplete="off"
      autocapitalize="off"
      spellcheck="false"
      tabindex="-1"
      readonly
    />

    <!-- This script installs service_worker.js to provide PWA functionality to
       application. For more information, see:
       https://developers.google.com/web/fundamentals/primers/service-workers -->
    <script>
      const serviceWorkerVersion = "1762334347";
let scriptLoaded = false;

function loadMainDartJs() {
  if (scriptLoaded) {
    return;
  }
  scriptLoaded = true;
  const scriptTag = document.createElement("script");
  scriptTag.src = "main.dart.js";
  scriptTag.type = "application/javascript";
  document.body.append(scriptTag);
}

if ("serviceWorker" in navigator) {
  window.addEventListener("load", function () {
    const serviceWorkerUrl = "flutter_service_worker.js?v=" + serviceWorkerVersion;

    navigator.serviceWorker.register(serviceWorkerUrl).then((reg) => {
      function waitForActivation(serviceWorker) {
        if (!serviceWorker) {
          return;
        }
        serviceWorker.addEventListener("statechange", () => {
          if (serviceWorker.state === "activated") {
            console.log("Installed new service worker.");
            loadMainDartJs();
          } else if (serviceWorker.state === "redundant") {
            console.warn("Service worker became redundant.");
            loadMainDartJs(); // Fallback to loading the script
          }
        });
      }

      if (!reg.active && (reg.installing || reg.waiting)) {
        waitForActivation(reg.installing ?? reg.waiting);
      } else if (!reg.active.scriptURL.endsWith(serviceWorkerVersion)) {
        console.log("New service worker available.");
        reg.update().then(() => {
          waitForActivation(reg.installing);
        }).catch(() => {
          console.warn("Service worker update failed.");
          loadMainDartJs(); // Fallback to loading the script
        });
      } else {
        console.log("Loading app from service worker.");
        loadMainDartJs();

      }

      reg.addEventListener("updatefound", () => {
        if (reg.installing) {
          waitForActivation(reg.installing);
        }
      });
    }).catch((error) => {
      alert(error);
      console.error("Service worker registration failed:", error);
      loadMainDartJs(); // Fallback to loading the script
    });

    // setTimeout(() => {
    //   if (!scriptLoaded) {
    //     console.warn("Failed to load app from service worker. Falling back to plain <script> tag.");
    //     loadMainDartJs();
    //   }
    // }, 4000);
  });
} else {
  loadMainDartJs();
}

    </script>
  </body>
</html>
